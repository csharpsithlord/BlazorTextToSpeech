@page "/"
@inject IJSRuntime JS

<h3>Client Text-to-Speech</h3>

<div class="mb-2">
    <label>Voice:</label>
    <select @bind="SelectedVoiceName">
        @foreach (var v in Voices)
        {
            <option value="@v.Name">@v.Name (@v.Lang)@(v.IsDefault ? " • default" : "")</option>
        }
    </select>
</div>

<div class="mb-2">
    <label>Text to read:</label>
    <textarea class="form-control" rows="4" @bind="TextToSpeak"></textarea>
</div>

<div class="mb-2">
    <label>Rate</label>
    <input type="range" min="0.5" max="2" step="0.1" @bind="Rate" />
    <span>@Rate.ToString("0.0")</span>
</div>
<div class="mb-2">
    <label>Pitch</label>
    <input type="range" min="0" max="2" step="0.1" @bind="Pitch" />
    <span>@Pitch.ToString("0.0")</span>
</div>
<div class="mb-3">
    <label>Volume</label>
    <input type="range" min="0" max="1" step="0.05" @bind="Volume" />
    <span>@Volume.ToString("0.00")</span>
</div>

<button class="btn btn-primary me-2" @onclick="Speak">Speak</button>
<button class="btn btn-secondary" @onclick="Stop">Stop</button>

@code {
    private IJSObjectReference? _speech;
    private List<VoiceInfo> Voices = new();
    private string? SelectedVoiceName;
    private string TextToSpeak = "This is Blazor text to speech!";
    private double Rate = 1.0, Pitch = 1.0, Volume = 1.0;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        _speech = await JS.InvokeAsync<IJSObjectReference>("import", "./js/speech.js");

        // Ensure voices are loaded, then fetch them
        await _speech.InvokeVoidAsync("waitForVoices");
        var raw = await _speech.InvokeAsync<VoiceInfo[]>("getVoices");
        Voices = raw.OrderBy(v => v.Lang).ThenBy(v => v.Name).ToList();
        SelectedVoiceName = Voices.FirstOrDefault(v => v.IsDefault)?.Name ?? Voices.FirstOrDefault()?.Name;

        StateHasChanged();
    }

    private async Task Speak()
    {
        if (_speech is null) return;
        await _speech.InvokeVoidAsync("speak", TextToSpeak, new
        {
            voiceName = SelectedVoiceName,
            rate = Rate,
            pitch = Pitch,
            volume = Volume
        });
    }

    private async Task Stop()
    {
        if (_speech is null) return;
        await _speech.InvokeVoidAsync("stop");
    }

    public async ValueTask DisposeAsync()
    {
        if (_speech is not null) await _speech.DisposeAsync();
    }

    private record VoiceInfo(string Name, string Lang, bool IsDefault);
}
